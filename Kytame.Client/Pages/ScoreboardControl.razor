@page "/scoreboard-control/{GroupName}"
@using Microsoft.AspNetCore.SignalR.Client
@rendermode InteractiveWebAssembly
@using System.Timers
@inject NavigationManager Navigation

<div class="scoreboard-control-container">
    <div class="buttons-container">
        <div class="team-control red">
            <h2>Participante 1</h2>
            <div class="controls">
                <button @onclick="IncrementTeam1Score" class="large-button">Punto +</button>
                <button @onclick="DecrementTeam1Score" class="large-button">Punto -</button>
                <button @onclick="IncrementTeam1Penalty" class="large-button">Penalty +</button>
                <button @onclick="DecrementTeam1Penalty" class="large-button">Penalty -</button>
            </div>
        </div>

        <div class="team-control blue">
            <h2>Participante 2</h2>
            <div class="controls">
                <button @onclick="IncrementTeam2Score" class="large-button">Punto +</button>
                <button @onclick="DecrementTeam2Score" class="large-button">Punto -</button>
                <button @onclick="IncrementTeam2Penalty" class="large-button">Penalty 1</button>
                <button @onclick="DecrementTeam2Penalty" class="large-button">Penalty -</button>
            </div>
        </div>
    </div>

    <div class="timer-control">
        <h2>Timer Control</h2>
        <div class="controls">
            <button @onclick="StartStopTimer" class="small-button">@((timerRunning ? "Parar Timer" : "Empeezar Timer"))</button>
            <button @onclick="ResetTimer" class="small-button">Reset Timer</button>
        </div>
    </div>
</div>

@code {
    [Parameter] public string GroupName { get; set; } = string.Empty;

    private int team1Score = 0;
    private int team2Score = 0;
    private int team1Penalty = 0;
    private int team2Penalty = 0;
    private int currentRound = 1;

    private Timer timer;
    private int timerMinutes = 1;
    private int timerSeconds = 50;
    private bool timerRunning = false;

    private HubConnection hubConnection;

    protected override async Task OnInitializedAsync()
    {
        timer = new Timer(1000);
        timer.Elapsed += async (sender, e) => await OnTimerElapsed();

        // Initialize SignalR connection
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/scoreboardHub"))
            .Build();

        // Register handler for receiving updates from the hub
        hubConnection.On<int, int, int, int>("ReceiveScoreUpdate", (t1Score, t2Score, t1Penalty, t2Penalty) =>
        {
            team1Score = t1Score;
            team2Score = t2Score;
            team1Penalty = t1Penalty;
            team2Penalty = t2Penalty;
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<int, int, bool>("ReceiveTimerUpdate", (minutes, seconds, isRunning) =>
        {
            timerMinutes = minutes;
            timerSeconds = seconds;
            timerRunning = isRunning;
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<int>("ReceiveRoundUpdate", (round) =>
        {
            currentRound = round;
            InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
        await hubConnection.SendAsync("JoinGroup", GroupName); // Unirse al grupo usando el parámetro de ruta
    }

    private async Task OnTimerElapsed()
    {
        if (timerMinutes == 0 && timerSeconds == 0)
        {
            timer.Stop();
            timerRunning = false;
        }
        else
        {
            if (timerSeconds == 0)
            {
                timerMinutes--;
                timerSeconds = 59;
            }
            else
            {
                timerSeconds--;
            }
        }
        await UpdateTimer();
        await InvokeAsync(StateHasChanged);
    }

    private async Task UpdateScore()
    {
        await hubConnection.SendAsync("UpdateScore", GroupName, team1Score, team2Score, team1Penalty, team2Penalty);
    }

    private async Task UpdateTimer()
    {
        await hubConnection.SendAsync("UpdateTimer", GroupName, timerMinutes, timerSeconds, timerRunning);
    }

    private async Task UpdateRound()
    {
        await hubConnection.SendAsync("UpdateRound", GroupName, currentRound);
    }

    private void IncrementTeam1Score()
    {
        team1Score++;
        UpdateScore();
    }

    private void DecrementTeam1Score()
    {
        if (team1Score > 0) team1Score--;
        UpdateScore();
    }

    private void IncrementTeam2Score()
    {
        team2Score++;
        UpdateScore();
    }

    private void DecrementTeam2Score()
    {
        if (team2Score > 0) team2Score--;
        UpdateScore();
    }

    private void IncrementTeam1Penalty()
    {
        team1Penalty++;
        UpdateScore();
    }

    private void DecrementTeam1Penalty()
    {
        if (team1Penalty > 0) team1Penalty--;
        UpdateScore();
    }

    private void IncrementTeam2Penalty()
    {
        team2Penalty++;
        UpdateScore();
    }

    private void DecrementTeam2Penalty()
    {
        if (team2Penalty > 0) team2Penalty--;
        UpdateScore();
    }

    private void StartStopTimer()
    {
        timerRunning = !timerRunning;
        if (timerRunning)
        {
            timer.Start();
        }
        else
        {
            timer.Stop();
        }
        UpdateTimer();
    }

    private void ResetTimer()
    {
        timer.Stop();
        timerRunning = false;
        timerMinutes = 1;
        timerSeconds = 50;
        UpdateTimer();
    }

    public async ValueTask DisposeAsync()
    {
        await hubConnection.SendAsync("LeaveGroup", GroupName); // Dejar el grupo al cerrar el componente
        await hubConnection.DisposeAsync();
        timer?.Dispose();
    }
}
